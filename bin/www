#!/usr/bin/env node
var debug = require('debug')('passport-mongo');
var app = require('../app');
var Data1= require('../models/data1');
var request = require('request');
var dbConfig = require('../db');
var mongoose = require('mongoose');

//var app=express();

// Connect to DB
console.log("Connect to DB")
mongoose.connect(dbConfig.url, function(error) {
  console.log("ERROR")
  console.log(error)
});

var db=mongoose.connection;


app.set('port', process.env.PORT || 8080);

var http = require('http').createServer(app);
var io = require('socket.io')(http);

function plotgraph(){
	
	console.log('plot function');
	
	/*Data1.find({},function (err, kittens1) {
				  if (err){console.log(err)};
				  
	//if (kittens1.length>0){		
		
		console.log(kittens1[0].data1);
		io.emit('plotgraph1', kittens1[0].data1);
	//}
	})*/
	io.emit('plotgraph1', '[{"name":"fb","data":[["fb","fb"],["2016-12-31",116.595],["2015-12-31",106],["2014-12-31",79.54],["2013-12-31",54.12],["2012-12-31",26.2]]},{"name":"msi","data":[["msi","msi"],["2016-12-31",83.17],["2015-12-31",69],["2014-12-31",67.54],["2013-12-31",67.18],["2012-12-31",53.93],["2011-12-31",46.57],["2010-12-31",8.91]]},{"name":"amzn","data":[["amzn","amzn"],["2016-12-31",766.47],["2015-12-31",686.08],["2014-12-31",311.55],["2013-12-31",394.58],["2012-12-31",243.75],["2011-12-31",173.36],["2010-12-31",181.96]]},{"name":"ms","data":[["ms","ms"],["2016-12-31",42.17],["2015-12-31",31.91],["2014-12-31",39.12],["2013-12-31",30.89],["2012-12-31",18.6],["2011-12-31",15.14],["2010-12-31",27.22]]},{"name":"msg","data":[["msg","msg"],["2016-12-31",173.25],["2015-12-31",159.41],["2014-12-31",75.52],["2013-12-31",57.96],["2012-12-31",43.78],["2011-12-31",28.52],["2010-12-31",25.63]]},{"name":"googl","data":[["googl","googl"],["2016-12-31",803.21],["2015-12-31",787.82],["2014-12-31",537.74],["2013-12-31",1112.24],["2012-12-31",700],["2011-12-31",642.02],["2010-12-31",596.74]]}]');
}

io.on('connection', function(socket){
	console.log('a user connected');
	plotgraph();

	socket.on('change graph', function(msg){
	      console.log('change graph');
	      msg = msg.replace(/\s/g, '');
	      var stock=msg;
	      var str='https://www.quandl.com/api/v3/datasets/WIKI/'+msg+'.json?column_index=1&start_date=2010-01-01&end_date=2017-01-01&collapse=annual&api_key=c3kCyhGGfJFsLUECjwwV';
	      var options = {
	        
				url: str
				
				};
				request.get(options, function(err,httpResponse,body)
				{ if (err) {console.log('idiot')} 
				var obj=JSON.parse(body); 
				
				if (obj.dataset!=undefined){
					var tmp =obj.dataset.data;
					var data2 =tmp //google.visualization.arrayToDataTable(tmp);
					data2.unshift([stock, stock]);
					
					var STOCK = {name:stock, data: data2 };
					
					Data1.find({},function (err, kittens1) {
						  if (err){};
						  if (kittens1.length<1){
						  var DATA=[];
						  DATA.push(STOCK);
						  var newdata=new Data1;
						  newdata.test='test';
						  newdata.data1=JSON.stringify(DATA);
						  newdata.save();
						  console.log("doc saved");
						  plotgraph();
						  return 0;
						  }
				else
				{
				  	var q=JSON.parse(kittens1[0].data1);
				  	var cntr=0;
				  	
				  	for (var i=0;i<q.length;i++)
				  	{
				  		if (q[i].name==stock)
				  		{cntr++;}
				  	
				  	}
				  	if (cntr<1){
				  	
					  	q.push(STOCK);
					  	Data1.update(
				    		{ test : 'test' },
				    		{ data1: JSON.stringify(q) },
				    	function(err,res){
					    	if (err) {throw err}
					    	console.log("1 doc updated");
					    	
							plotgraph();
					    	return 0;
			    	
				    	}
						)	
						}
				  	else {console.log('already present!')
				  		plotgraph();
				  	}
					  
					  }
					  })
					  }
					  else{
					  	console.log("nostock")
					  	io.emit("nostock","good") }
	            
		});

		})
		
		socket.on('add stock', function(msg){
		io.emit('add stock', msg);
		})
		
		
		socket.on('delete graph', function(msg){
		console.log(msg);
		Data1.find({},function (err, kittens1) {
			if (err){};
			var q=JSON.parse(kittens1[0].data1);
			var j;
			for (var i=0;i<q.length;i++)
			{
			  	if (q[i].name==msg)
			  	{j=i;}
				
			}
			q.splice(j,1);
			Data1.update(
			{ test : 'test' },
			{ data1: JSON.stringify(q) },
			function(err,res){
				if (err) {throw err}
				console.log("1 doc updated");
				plotgraph();
			return 0;
				    }
						)
		})
		})
		})

  http.listen(app.get('port'), function(){
	console.log('listening on *:3000');
});


